# Windows Code Signing Script for CPack
# This script is configured by CMake and executed by CPack before packaging
#
# It signs all executables and DLLs in the installation directory before
# they are packaged into the installer.

set(SIGNTOOL "@SIGNTOOL_EXECUTABLE@")
set(SIGN_IDENTITY "@IVW_WINDOWS_SIGN_IDENTITY@")
set(TIMESTAMP_URL "@IVW_WINDOWS_TIMESTAMP_URL@")

# Get staging directory from CPack
set(STAGING_DIR "${CPACK_TEMPORARY_INSTALL_DIRECTORY}")

message(STATUS "Code signing files in: ${STAGING_DIR}")

# Function to sign a single file
function(sign_file file_path)
    if(NOT SIGNTOOL)
        message(WARNING "SignTool not available")
        return()
    endif()
    
    set(sign_cmd "${SIGNTOOL}" sign)
    if(SIGN_IDENTITY)
        list(APPEND sign_cmd /sha1 "${SIGN_IDENTITY}")
    else()
        list(APPEND sign_cmd /a)
    endif()
    if(TIMESTAMP_URL)
        list(APPEND sign_cmd /tr "${TIMESTAMP_URL}" /td sha256)
    endif()
    list(APPEND sign_cmd /fd sha256 /v "${file_path}")
    
    message(STATUS "Signing: ${file_path}")
    execute_process(
        COMMAND ${sign_cmd}
        RESULT_VARIABLE result
        OUTPUT_VARIABLE output
        ERROR_VARIABLE error
    )
    
    if(NOT result EQUAL 0)
        message(WARNING "Failed to sign ${file_path}: ${error}")
    endif()
endfunction()

# Find and sign all EXE and DLL files
file(GLOB_RECURSE exe_files "${STAGING_DIR}/*.exe")
file(GLOB_RECURSE dll_files "${STAGING_DIR}/*.dll")

set(files_to_sign ${exe_files} ${dll_files})
list(LENGTH files_to_sign num_files)
message(STATUS "Found ${num_files} files to sign")

foreach(file IN LISTS files_to_sign)
    sign_file("${file}")
endforeach()

message(STATUS "Code signing complete")

set(IVW_PACKAGE_SELECT_APP "@IVW_PACKAGE_SELECT_APP@")
set(APP_BUNDLE_PATH "${CPACK_TEMPORARY_INSTALL_DIRECTORY}/${IVW_PACKAGE_SELECT_APP}.app")

message(STATUS "Running deploy-os on: ${APP_BUNDLE_PATH}")

file(GLOB_RECURSE lib_files LIST_DIRECTORIES false ${APP_BUNDLE_PATH}/*.dylib)
foreach(lib_file IN LISTS lib_files)
    execute_process(
        COMMAND codesign --force --sign - "${lib_file}"
        RESULT_VARIABLE exit_code
        COMMAND_ECHO STDOUT
    )
    if (NOT exit_code EQUAL 0)
        message(FATAL_ERROR "Running codesign failed with error: ${exit_code}")
    endif()
endforeach()

file(GLOB_RECURSE so_files LIST_DIRECTORIES false ${APP_BUNDLE_PATH}/*.so)
foreach(so_files IN LISTS so_files)
    execute_process(
        COMMAND codesign --force --sign - "${so_files}"
        RESULT_VARIABLE exit_code
        COMMAND_ECHO STDOUT
    )
    if (NOT exit_code EQUAL 0)
        message(FATAL_ERROR "Running codesign failed with error: ${exit_code}")
    endif()
endforeach()

execute_process(
    COMMAND codesign --force --deep --sign - "${APP_BUNDLE_PATH}"
    RESULT_VARIABLE exit_code
    COMMAND_ECHO STDOUT
)
if (NOT exit_code EQUAL 0)
    message(FATAL_ERROR "Running codesign failed with error: ${exit_code}")
endif()
